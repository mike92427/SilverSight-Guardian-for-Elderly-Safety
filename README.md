# 🏥 SilverSight Pro v5.0 - 智能老人照護監控系統

一個功能完整的**多攝影機監控平台**，專為老人照護設計。整合跌倒偵測、姿勢分析、物品追蹤、Telegram 遠端控制等功能。

---

## ✨ 核心功能

### 🚨 **安全監控**
- ✅ **跌倒偵測** - 基於 MediaPipe 姿勢分析的即時跌倒警報
- ✅ **求救手勢辨識** - 自動偵測雙手舉起的求救信號
- ✅ **久坐提醒** - 監測久坐時間，定時語音提醒
- ✅ **事件錄影** - 偵測到異常時自動錄製 5 秒前後的影片

### 📹 **攝影機管理**
- ✅ **動態新增/移除** - 透過 Telegram 指令即時新增或刪除攝影機
- ✅ **多攝影機支援** - 支援無限數量的攝影機串流
- ✅ **自適應網格顯示** - 自動排列 1、2、4 台攝影機的顯示方式
- ✅ **隱私模式** - 平時模糊顯示，異常時清晰顯示

### 🤖 **智能物品追蹤**
- 使用 YOLOv8 偵測並追蹤：手機、鑰匙、皮包、背包、遙控器、水壺、杯子、滑鼠、鍵盤等
- 支援 `/find` 指令快速定位物品位置

### 📱 **Telegram 遠端控制**
- 使用者自助註冊、登入、多裝置綁定
- 實時查看監控畫面
- 語音廣播消息
- 物品查詢
- 攝影機管理（新增/修改/刪除）

### 🎤 **語音互動**
- 基於 Google TTS 的中文語音播報
- 支援自訂提醒訊息

---

## 📋 系統需求

### 硬體
- CPU: Intel/AMD 雙核以上
- RAM: 4GB 以上
- 網路: 穩定的網際網路連線（用於 Telegram）

### 軟體
- Python 3.8+
- OpenCV 4.5+
- MediaPipe 0.8+
- YOLOv8 (ultralytics)
- 其他依賴見 [安裝步驟](#-安裝步驟)

---

## 🚀 安裝步驟

### 1️⃣ 克隆或下載專案
```bash
cd 你的項目目錄
```

### 2️⃣ 建立虛擬環境（推薦）
```bash
python -m venv venv
# Windows
venv\Scripts\activate
# Mac/Linux
source venv/bin/activate
```

### 3️⃣ 安裝依賴
```bash
pip install -r requirements.txt
```

### 4️⃣ 設定環境變數
在專案根目錄建立 `.env` 檔案：
```
TELEGRAM_TOKEN=你的_Telegram_Bot_Token
TELEGRAM_CHAT_ID=你的_Telegram_Chat_ID（可選）
```

#### 📌 如何取得 Telegram Bot Token？
1. 在 Telegram 中找 `@BotFather`
2. 傳送 `/newbot` 命令
3. 按照提示建立新機器人
4. 複製提供的 Token

### 5️⃣ 準備攝影機
- 使用IP webcam的app將手機平板等裝置變成可以被調用的攝影機
- 
### 6️⃣ 執行程式
```bash
python silversight_v2_addyolo_telegram_v9.py
```

---

## 📱 Telegram 指令大全

### 👤 **帳號管理**
| 指令 | 說明 |
|------|------|
| `/register <user_id> <密碼>` | 註冊新帳號 |
| `/login <user_id> <密碼>` | 使用帳號登入 |
| `/login <配對碼>` | 使用配對碼登入（多裝置） |
| `/logout` | 登出此裝置 |

### 📹 **監控功能**
| 指令 | 說明 |
|------|------|
| `/status` | 查看所有監控畫面（隱私模式模糊） |
| `/current` | 查看清晰實況畫面 |
| `/listcams` | 列出你的攝影機清單 |

### 🎥 **攝影機管理**
| 指令 | 說明 |
|------|------|
| `/addcam <名稱> <網址>` | 新增攝影機（支援 RTSP/HTTP） |
| `/editcam <名稱> <新網址>` | 修改攝影機網址 |
| `/delcam <名稱>` | 刪除攝影機 |

### 🔍 **物品查詢**
| 指令 | 範例 |
|------|------|
| `/find <物品>` | `/find 手機` 、 `/find 鑰匙` 、 `/find 遙控器` |

### 🎤 **語音互動**
| 指令 | 範例 |
|------|------|
| `/say <訊息>` | `/say 站起來` 、 `/say 吃藥囉` 、 `/say 喝水囉` |

### ℹ️ **其他**
| 指令 | 說明 |
|------|------|
| `/menu` | 顯示快捷按鈕菜單 |
| `/help` | 顯示完整指令說明 |

---

## ⚙️ 系統配置

在程式碼開頭修改以下參數：

```python
# 功能設定
PRIVACY_MODE = True                    # 隱私模式開關
SEDENTARY_ALERT_SEC = 10               # 久坐提醒時間（秒，測試用）
SEDENTARY_DIST_THRES = 0.15            # 久坐移動判斷門檻

# 錄影參數
VIDEO_BUFFER_SECONDS = 5               # 事件前緩衝時長
VIDEO_POST_SECONDS = 5                 # 事件後錄製時長
FPS = 10                               # 錄影幀率

# 物品追蹤清單
TRACK_ITEMS = {
    67: 'cell phone',
    26: 'handbag',
    24: 'backpack',
    65: 'remote',
    39: 'bottle',
    41: 'cup',
    64: 'mouse',
    65: 'keyboard'
}
```

---

## 🔑 核心技術

### 📊 **跌倒偵測演算法**
- **輸入**: MediaPipe 偵測的 33 個身體關鍵點
- **關鍵指標**:
  - 軀幹與垂直線的角度 (>60° 判定為跌倒)
  - 身體寬高比 (>1.4 判定為趴倒)
  - 髖部位置 (>0.7 表示在下方)
  - 垂直距離 (鼻子與髖部距離)

- **坐姿過濾**: 自動排除坐著姿勢的誤判
- **確認機制**: 需要連續 10 幀以上的跌倒信號才會觸發警報

### 🤖 **物品追蹤**
- 使用 **YOLOv8n** 輕量級模型
- 置信度閾值: 0.4
- 支援 COCO 資料集中的 80 種物體
- 記錄最後一次看到該物品的位置

### 🛡️ **隱私保護**
- 非警報狀態下，使用高斯模糊保護隱私
- 警報觸發時自動切換為清晰顯示
- 使用者權限管理：只能查看自己的攝影機

---

## 📂 檔案結構

```
.
├── silversight_v2_addyolo_telegram_v9.py  # 主程式
├── users.json                              # 使用者資料庫
├── subscribed_users.json                   # 訂閱使用者清單
├── .env                                    # 環境變數設定
├── requirements.txt                        # Python 依賴
└── README.md                               # 本檔案
```

### 資料庫結構 (users.json)
```json
{
  "users": [
    {
      "user_id": "alice",
      "chat_id": 123456789,
      "chat_ids": [123456789, 987654321],
      "pair_code": "ABC123",
      "cameras": [
        {
          "name": "客廳",
          "src": "rtsp://192.168.1.100:554/stream",
          "timeout": 2.0
        }
      ],
      "password_salt": "...",
      "password_hash": "..."
    }
  ]
}
```

---

## 🔒 安全特性

- ✅ **密碼加密** - 使用 PBKDF2-SHA256 加鹽雜湊
- ✅ **多裝置支援** - 單一帳號可綁定多台裝置
- ✅ **權限隔離** - 使用者只能存取自己的攝影機
- ✅ **配對碼機制** - 安全的多裝置綁定方式
- ✅ **隱私模式** - 平時自動模糊監控畫面

---

## 📊 效能指標

| 項目 | 數值 |
|------|------|
| 最大攝影機數 | 無限制（取決於硬體） |
| 跌倒偵測延遲 | ~200-300ms |
| 物品追蹤更新頻率 | 每 3 秒 |
| Telegram 回應時間 | ~1-2 秒 |
| 影片緩衝大小 | 5 秒（預設） |

---

## 🐛 疑難排解

### ❌ 攝影機無法連線
```python
# 檢查攝影機地址是否正確
# 對於 RTSP 串流: rtsp://ip:port/stream
# 對於 USB 攝影機: 0 (第一個裝置)
# 如果無法連線，會在 2 秒後自動重試
```

### ❌ Telegram 無法傳送訊息
- 檢查 `.env` 中的 `TELEGRAM_TOKEN` 是否正確
- 確認網際網路連線正常
- 確認 bot 已添加到群組（如需要）

### ❌ 跌倒偵測誤判
- 調整 MediaPipe 置信度 (0.5 是預設值)
- 檢查攝影機角度（建議從上往下 45° 拍攝）
- 增加確認幀數 (改變 fall_cnt 閾值)

### ⚠️ 高 CPU 使用率
- 減少攝影機數量
- 降低 FPS (從 10 改成 5)
- 使用輕量級 YOLO 模型 (yolov8n)
- 增加 sleep 時間間隔

---

## 📝 日誌說明

程式運行時會輸出以下類型的日誌：

```
[攝影機名稱] 連線至: rtsp://...
[攝影機名稱] 連線成功！
[語音] 生成: 系統啟動
[Telegram] 廣播給 2 位目標用戶: ✅ SilverSight...
[客廳] 🔴 啟動事件錄影...
[UsersDB] Save error: ...
```

---

## 🚀 進階用法

### 多使用者協作
1. 創建多個 Telegram 帳號
2. 每個使用者執行 `/register` 建立帳號
3. 使用 `/addcam` 各自新增自己的攝影機
4. 系統自動隔離權限

### 配置多台監控機器
1. 在機器 A 上啟動此程式
2. 在機器 B 上新增攝影機指向機器 A 的串流
3. 所有機器共享同一個 Telegram Bot

---

## 📄 授權

此專案用於教學與研究目的。

---

## 👨‍💻 開發者資訊

- **作者**: 吳宜謙 劉家豪
- **版本**: v1.0
- **最後更新**: 2025-12-19

---

## 📞 支援

若有問題或建議，請檢查以下項目：
1. 所有依賴是否正確安裝
2. `.env` 檔案是否正確設定
3. 攝影機網址是否可訪問
4. Telegram Bot Token 是否有效

---

## 🎉 特別感謝

- **MediaPipe** - 姿勢偵測
- **Ultralytics YOLOv8** - 物體偵測
- **OpenCV** - 影像處理
- **Telegram Bot API** - 通訊平台
- **gTTS** - 語音合成



